<?xml version="1.0"?>
<launch>
<!--  <arg name="image_in" default="/vizzy/l_camera/image_rect_color" /> -->

  <arg name="namespace" default="people_follower" />

  <arg name="image_in" default="/head_camera/rgb/image_raw" />
  <arg name="image_out" default="pedestrian_detector_image" />
  
  <arg name="detector_type" default="full" />
  <arg name="camera" default="head_camera" />
  
  <arg name="follower" default="true" />
  <arg name="tracker" default="true" />

  <arg name="launch_navigation_stack" default="false" />
  <arg name="visualisation" default="true" />
  <arg name="following_planner_mode" default="global_map" /> <!-- TODO remove -->


  <arg name="navigation_stack"              default="nav_2d" />
  <arg name="navigation_type"               default="path_following" />
  <arg name="person_pose_minimum_distance"  default="0.0" />
  <arg name="target_pose_minimum_distance"  default="0.75" />
  <arg name="path_minimum_distance"         default="0.25" />

  <node pkg="rosservice" type="rosservice" name="rosservice_follow_now_node" args="call --wait /FollowNow 'start: true' " />


  <include file="$(find mbot_2dnav)/ros/launch/2dnav_people_following.launch" if="$(arg launch_navigation_stack)"/>
  
  <group ns="$(arg namespace)">

    <group if="$(arg follower)">
      <node pkg="pedestrian_detector" type="follower" name="follower" output="screen">
        
        <rosparam file="$(find pedestrian_detector)/config/follower_params_$(arg following_planner_mode).yaml" command="load"/>

        <param name="default_navigation_stack"      type="string"   value="$(arg navigation_stack)" />
        <param name="default_navigation_type"       type="string"   value="$(arg navigation_type)" />
        <param name="person_pose_minimum_distance"  type="double"   value="$(arg person_pose_minimum_distance)" />
        <param name="target_pose_minimum_distance"  type="double"   value="$(arg target_pose_minimum_distance)" />
        <param name="path_minimum_distance"         type="double"   value="$(arg path_minimum_distance)" />

        <remap from="twist_topic" to="/cmd_vel_prio_medium"/>
        <!--<remap from="/move_base_simple/goal" to="/null/move_base_simple/goal"/>-->
        
      </node>
    </group>
  
    <node pkg="pedestrian_detector" type="yolo_converter" name="yolo_to_people_detections_converter" args="yolo_detections:=/detection_result people_detections:=detections" output="screen"/>

    <include file="$(find bayes_people_tracker)/launch/people_tracker_people_following.launch" if="$(arg tracker)"/>
    
    <node pkg="hector_trajectory_server" type="hector_trajectory_server" name="hector_trajectory_server" output="screen" if="$(arg visualisation)">
      <param name="target_frame_name" type="string" value="/map" />
      <param name="source_frame_name" type="string" value="/base_link" />
      <param name="trajectory_update_rate" type="double" value="10" />
      <param name="trajectory_publish_rate" type="double" value="10" />
      <remap from="trajectory" to="robot_trajectory" />
    </node>

    <node pkg="pedestrian_detector" type="centralp" name="before_tracker">
    </node>
    
    <node pkg="pedestrian_detector" type="after" name="after_tracker">
    </node>

    
  </group>
</launch>
